<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Posters</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app">
        <a class="retour" href="index.html">← Accueil</a>
        <h1>Posters</h1>

        <!-- Messages -->
        <p class="msg-error" v-if="erreur">{{ erreur }}</p>
        <p class="msg-info"  v-if="confirmation">{{ confirmation }}</p>

        <!-- Formulaire : ajout ou édition -->
        <div class="form-section">
            <h2>{{ formulaire.mode === 'ajout' ? 'Ajouter un poster' : 'Modifier le poster' }}</h2>
            <div class="form-row">
                <label>ID</label>
                <input v-model="formulaire.id" :disabled="formulaire.mode === 'edition'"
                       placeholder="identifiant unique" />
            </div>
            <div class="form-row">
                <label>Titre</label>
                <input v-model="formulaire.titre" placeholder="titre du poster" />
            </div>
            <div class="form-row">
                <label>URL de l'image</label>
                <input v-model="formulaire.url" placeholder="https://..." />
            </div>
            <div class="form-actions">
                <button class="btn-primary" @click="soumettreFormulaire">
                    {{ formulaire.mode === 'ajout' ? 'Ajouter' : 'Enregistrer' }}
                </button>
                <button class="btn-secondary" v-if="formulaire.mode === 'edition'" @click="annulerEdition">
                    Annuler
                </button>
            </div>
        </div>

        <!-- Liste -->
        <p class="loading" v-if="chargement">Chargement…</p>
        <p v-else-if="posters.length === 0 && !erreur">Aucun poster pour l'instant.</p>
        <div class="posters-grid" v-else>
            <div class="poster-card" v-for="p in posters" :key="p.id">
                <img :src="p.url" :alt="p.titre" @error="imageErreur($event)" />
                <div class="info">
                    <div class="titre">{{ p.titre }}</div>
                    <div class="id">id : {{ p.id }}</div>
                    <div class="actions">
                        <button class="btn-edit"   @click="editer(p)">Modifier</button>
                        <button class="btn-danger" @click="supprimer(p.id)">Supprimer</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        // ─── URL de l'API ─────────────────────────────────────────────────────────
        // À remplacer par l'URL de la gateway quand elle sera disponible.
        const API_URL = 'http://localhost:8081/api/posters'
        // ─────────────────────────────────────────────────────────────────────────

        const App = {
            data() {
                return {
                    posters:      [],
                    chargement:   true,
                    erreur:       null,
                    confirmation: null,
                    formulaire: {
                        mode:  'ajout',   // 'ajout' | 'edition'
                        id:    '',
                        titre: '',
                        url:   '',
                    }
                }
            },

            created() {
                this.chargerPosters()
            },

            methods: {
                // ── Lecture ──────────────────────────────────────────────────────
                async chargerPosters() {
                    this.chargement = true
                    this.erreur = null
                    try {
                        const res = await fetch(API_URL)
                        if (!res.ok) throw new Error(`Erreur ${res.status}`)
                        this.posters = await res.json()
                    } catch (e) {
                        this.erreur = 'Impossible de charger les posters : ' + e.message
                    } finally {
                        this.chargement = false
                    }
                },

                // ── Formulaire ───────────────────────────────────────────────────
                soumettreFormulaire() {
                    if (this.formulaire.mode === 'ajout') {
                        this.ajouterPoster()
                    } else {
                        this.modifierPoster()
                    }
                },

                editer(poster) {
                    this.formulaire.mode  = 'edition'
                    this.formulaire.id    = poster.id
                    this.formulaire.titre = poster.titre
                    this.formulaire.url   = poster.url
                    window.scrollTo({ top: 0, behavior: 'smooth' })
                },

                annulerEdition() {
                    this.formulaire = { mode: 'ajout', id: '', titre: '', url: '' }
                },

                // ── Ajout ─────────────────────────────────────────────────────────
                async ajouterPoster() {
                    this.erreur = null
                    this.confirmation = null
                    const { id, titre, url } = this.formulaire
                    if (!id || !titre || !url) {
                        this.erreur = 'Tous les champs sont obligatoires.'
                        return
                    }
                    try {
                        const res = await fetch(API_URL, {
                            method:  'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body:    JSON.stringify({ id, titre, url })
                        })
                        if (!res.ok) {
                            const err = await res.json()
                            throw new Error(err.message || `Erreur ${res.status}`)
                        }
                        this.formulaire = { mode: 'ajout', id: '', titre: '', url: '' }
                        this.confirmation = 'Poster ajouté avec succès.'
                        await this.chargerPosters()
                    } catch (e) {
                        this.erreur = e.message
                    }
                },

                // ── Modification ──────────────────────────────────────────────────
                async modifierPoster() {
                    this.erreur = null
                    this.confirmation = null
                    const { id, titre, url } = this.formulaire
                    if (!titre || !url) {
                        this.erreur = 'Le titre et l\'URL sont obligatoires.'
                        return
                    }
                    try {
                        const res = await fetch(`${API_URL}/${id}`, {
                            method:  'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body:    JSON.stringify({ titre, url })
                        })
                        if (!res.ok) {
                            const err = await res.json()
                            throw new Error(err.message || `Erreur ${res.status}`)
                        }
                        this.annulerEdition()
                        this.confirmation = 'Poster modifié avec succès.'
                        await this.chargerPosters()
                    } catch (e) {
                        this.erreur = e.message
                    }
                },

                // ── Suppression ───────────────────────────────────────────────────
                async supprimer(id) {
                    if (!confirm(`Supprimer le poster « ${id} » ?`)) return
                    this.erreur = null
                    this.confirmation = null
                    try {
                        const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' })
                        if (!res.ok) {
                            const err = await res.json()
                            throw new Error(err.message || `Erreur ${res.status}`)
                        }
                        this.confirmation = `Poster « ${id} » supprimé.`
                        await this.chargerPosters()
                    } catch (e) {
                        this.erreur = e.message
                    }
                },

                // ── Utilitaire ────────────────────────────────────────────────────
                imageErreur(event) {
                    event.target.style.background = '#ddd'
                    event.target.style.height = '80px'
                }
            }
        }

        Vue.createApp(App).mount('#app')
    </script>
</body>
</html>
